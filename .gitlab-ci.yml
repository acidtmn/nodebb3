stages:
  - build

build:
  stage: build
  image: docker:git
  services:
    - docker:dind
  script:
    - "docker login -u nilsramsperger -p $DOCKERHUB_TOKEN"
    - "docker build --no-cache -t nilsramsperger/nodebb:latest ."
  only:
    - master
    - 1.x.x
  except:
    changes:
      - README.md
      - scripts/**

build-publish-1xx:
  stage: build
  image: docker:git
  services:
    - docker:dind
  script:
    - "docker login -u nilsramsperger -p $DOCKERHUB_TOKEN"
    - "docker build --no-cache -t nilsramsperger/nodebb:$CI_BUILD_REF_NAME ."
    - "docker push nilsramsperger/nodebb:$CI_BUILD_REF_NAME"
  only:
    - /^v1\..*$/
  except:
    changes:
      - README.md
      - scripts/**

build-publish-2xx:
  stage: build
  image: docker:git
  services:
    - docker:dind
  script:
    - "docker login -u nilsramsperger -p $DOCKERHUB_TOKEN"
    - "docker build --no-cache -t nilsramsperger/nodebb:$CI_BUILD_REF_NAME ."
    - "docker push nilsramsperger/nodebb:$CI_BUILD_REF_NAME"
    - "docker tag nilsramsperger/nodebb:$CI_BUILD_REF_NAME nilsramsperger/nodebb:latest"
    - "docker push nilsramsperger/nodebb:latest"
  only:
    - /^v2\..*$/
  except:
    changes:
      - README.md
      - scripts/**
